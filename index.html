<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>GeoMap Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map {
      height: 90vh;
      width: 100%;
    }

    #filterPanel {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      padding: 10px;
      border: 1px solid #ccc;
      z-index: 1000;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      font-size: 14px;
      width: 240px;
      max-width: 90vw;
      display: none;
    }

    #filterPanel h4 {
      margin-top: 0;
      font-size: 16px;
    }

    #filterPanel label {
      display: block;
      margin-bottom: 5px;
    }

    #filterPanel select,
    #filterPanel input[type="text"] {
      width: 100%;
      margin-bottom: 8px;
      padding: 4px;
      box-sizing: border-box;
    }

    #filterPanel button {
      width: 100%;
      margin-top: 5px;
      background: #f0f0f0;
      border: 1px solid #aaa;
      padding: 4px;
      cursor: pointer;
    }

    #toggleFilterBtn {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1100;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #0078D7;
      color: white;
      border: none;
      font-size: 20px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      cursor: pointer;
    }
  </style>
</head>

<body>
  <button id="toggleFilterBtn" title="‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á">üîç</button>

  <div id="filterPanel">
    <h4>üîç ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</h4>
    <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà/‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î..." />
    <label>‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì:
      <select id="yearFilter">
        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        <option>‡∏õ‡∏µ 63</option>
        <option>‡∏õ‡∏µ 64</option>
        <option>‡∏õ‡∏µ 65</option>
        <option>‡∏õ‡∏µ 66</option>
      </select>
    </label>
    <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:
      <select id="typeFilter">
        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        <option>PD</option>
        <option>PDH</option>
        <option>PM</option>
        <option>PL</option>
        <option>PLS</option>
        <option>ST</option>
        <option>ST II S</option>
      </select>
    </label>
    <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:
      <select id="statusFilter">
        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        <option>‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</option>
        <option>‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</option>
      </select>
    </label>
    <button onclick="resetFilters()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const sheetId = '1OF8QYGVpeiKjVToRvJQfTuKUreZTOcc9yZYxQXlh5vQ';
    const apiKey = 'AIzaSyBJ99_hsyJJQe4SyntE4SzORk8S0VhNF7I';
    const sheetNames = [
      '‡πÄ‡∏≠‡∏ô ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ô‡∏Ñ',
      '‡∏≠‡∏¥‡∏ô‡πÇ‡∏ô‡∏ß‡∏≤‡πÄ‡∏ó‡∏Ñ ‡πÇ‡∏ã‡∏•‡∏π‡∏ä‡∏±‡πà‡∏ô',
      '‡∏û‡∏¥‡∏ô‡∏û‡∏≠‡∏¢‡∏ó‡πå ‡∏≠‡∏¥‡∏ô‡πÇ‡∏ô‡πÄ‡∏ß‡∏ä‡∏±‡πà‡∏ô',
      '‡∏≠‡∏µ‡∏™‡∏≤‡∏ô-‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á',
      '‡πÄ‡∏≠‡∏™‡∏ó‡∏µ‡∏≠‡∏≤‡∏£‡πå ‡∏≠‡∏¥‡∏ô‡πÇ‡∏ô‡πÄ‡∏ß‡∏ä‡∏±‡πà‡∏ô',
      '‡πÄ‡∏Ç‡∏ï 7'
    ];

    const map = L.map('map').setView([15.2, 101.0], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const statusLayers = {
      "‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô": L.layerGroup().addTo(map),
      "‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô": L.layerGroup().addTo(map)
    };

    const allMarkers = [];

    function getDynamicRadius(zoom) {
      if (zoom >= 12) return 8;
      if (zoom >= 10) return 6;
      if (zoom >= 8) return 4;
      return 2;
    }

    const loadSheet = async (sheetName) => {
      const url = https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${encodeURIComponent(sheetName)}?key=${apiKey};
      const res = await fetch(url);
      const data = await res.json();

      if (!data.values) return;

      const [headersRaw, ...rows] = data.values;
      const headers = headersRaw.map(h => h.trim());
      const idx = col => headers.indexOf(col);

      rows.forEach((row, i) => {
        const lat = parseFloat(row[idx("Lat")]?.trim());
        const lng = parseFloat(row[idx("Long")]?.trim());
        const name = row[idx("‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà")] || "-";
        const type = row[idx("Type")] || "-";
        const year = row[idx("‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì")] || "-";
        const company = row[idx("‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó")] || "-";
        const province = row[idx("‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î")] || "-";
        const status = (row[idx("Status")] || "").trim();
        const endDate = row[idx("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô")] || "-";
        const contact = row[idx("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•")] || "-";
        const phone = row[idx("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£/‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•")] || "-";
        const mapUrl = row[idx("‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà")] || "";

        if (!lat || !lng || !status || !statusLayers[status]) return;

        const color = status === "‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô" ? "red" : "green";
        const radius = getDynamicRadius(map.getZoom());

        const marker = L.circleMarker([lat, lng], {
          color, fillColor: color, fillOpacity: 0.8, radius
        });

        marker.bindPopup(
          <b>${name}</b><br/>
          ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó: ${company}<br/>
          ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î: ${province}<br/>
          ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${type}<br/>
          ‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì: ${year}<br/>
          ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <b style="color:${color}">${status}</b><br/>
          ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô: ${endDate}<br/>
          ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•: ${contact}<br/>
          ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£: ${phone}<br/>
          ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà: <a href="${mapUrl}" target="_blank">‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π</a>
        );

        marker._meta = { type, year, status, name: name.toLowerCase(), province: province.toLowerCase() };
        marker.addTo(statusLayers[status]);
        allMarkers.push(marker);
      });
    };

    Promise.all(sheetNames.map(loadSheet));

    map.on("zoomend", () => {
      const zoom = map.getZoom();
      allMarkers.forEach(marker => marker.setRadius(getDynamicRadius(zoom)));
    });

    function applyFilter() {
      const type = document.getElementById("typeFilter").value;
      const year = document.getElementById("yearFilter").value;
      const status = document.getElementById("statusFilter").value;
      const search = document.getElementById("searchInput").value.trim().toLowerCase();

      allMarkers.forEach(marker => {
        const m = marker._meta;
        const visible = (!type || m.type === type) && (!year || m.year === year) && (!status || m.status === status) && (!search || m.name.includes(search) || m.province.includes(search));
        if (visible) marker.addTo(statusLayers[m.status]);
        else map.removeLayer(marker);
      });
    }

    function resetFilters() {
      document.getElementById("typeFilter").value = "";
      document.getElementById("yearFilter").value = "";
      document.getElementById("statusFilter").value = "";
      document.getElementById("searchInput").value = "";
      applyFilter();
    }

    ["typeFilter", "yearFilter", "statusFilter", "searchInput"].forEach(id =>
      document.getElementById(id).addEventListener("change", applyFilter)
    );
    document.getElementById("searchInput").addEventListener("input", applyFilter);

    // ‡∏õ‡∏∏‡πà‡∏° toggle ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô filter
    document.getElementById("toggleFilterBtn").addEventListener("click", () => {
      const panel = document.getElementById("filterPanel");
      panel.style.display = panel.style.display === "none" ? "block" : "none";
    });
  </script>
</body>

</html>
